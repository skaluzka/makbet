#!/usr/bin/env bash
set -eu


# ${1} - Path to T1 *.started.cfg event file.
# ${2} - Path to T2 *.terminated.cfg event file.
# ${3} - Path to results *.cfg file.

# shellcheck source=/dev/null
. "${1}" && . "${2}"

# Define T1 variable (read-only) - take TASK_DATE_TIME_STARTED
# value from "${1}" file and convert it to seconds.NANOSECONDS
# format ssssssssss.NNNNNNNNN for further calculations.
readonly T1=$( date --date="${TASK_DATE_TIME_STARTED}" +"%s.%N" )

# Define T2 variable (read-only) - take TASK_DATE_TIME_TERMINATED
# value from "${2}" file and convert it to seconds.NANOSECONDS
# format ssssssssss.NNNNNNNNN for further calculations.
readonly T2=$( date --date="${TASK_DATE_TIME_TERMINATED}" +"%s.%N" )

# Calculate T2 - T1 time difference and round it to three
# decimal places (milliseconds).
readonly TASK_DURATION=$( date --date="0 ${T2} sec - ${T1} sec" +"%Hh:%Mm:%Ss.%3Nms" )

# Print profiling results to the console.
echo "Profiling results:"
echo "T1 = ${T1}"
echo "T2 = ${T2}"
echo "T2 - T1 = ${TASK_DURATION}"

# Create an emtpy results *.cfg file.
echo -n "" > "${3}"

# Save profiling data to results *.cfg file.
comm --nocheck-order "${1}" "${2}" \
    | grep -Pv "EVENT_TYPE" \
    | sed 's/^[ \t]*//' \
    > "${3}"
echo "TASK_DURATION=${TASK_DURATION}" >> "${3}"


# End of file
